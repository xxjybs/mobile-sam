# è„æ©™ç¼ºé™·åˆ†å‰² - çƒ­åŠ›å›¾å¯è§†åŒ–å·¥å…·

æœ¬å·¥å…·ç”¨äºå¯è§†åŒ–å’Œåˆ†æè„æ©™ç¼ºé™·åˆ†å‰²æ¨¡å‹çš„é¢„æµ‹ç»“æœï¼Œç”Ÿæˆçƒ­åŠ›å›¾å¯¹æ¯”é¢„æµ‹æ©ç ä¸çœŸå®æ©ç ã€‚

## åŠŸèƒ½ç‰¹ç‚¹

- ğŸ“Š **å·®å¼‚åˆ†æ**: æ¸…æ™°æ˜¾ç¤ºé¢„æµ‹ä¸çœŸå®æ©ç çš„å·®å¼‚
  - ğŸŸ¢ ç»¿è‰²: æ­£ç¡®é¢„æµ‹çš„ç¼ºé™· (True Positive)
  - ğŸ”´ çº¢è‰²: è¯¯æŠ¥ - é”™è¯¯é¢„æµ‹ä¸ºç¼ºé™· (False Positive)
  - ğŸŸ¡ é»„è‰²: æ¼æŠ¥ - é—æ¼çš„ç¼ºé™· (False Negative)
  - âš« é»‘è‰²: æ­£ç¡®çš„èƒŒæ™¯ (True Negative)

- ğŸ“ˆ **è¯„ä¼°æŒ‡æ ‡**: è‡ªåŠ¨è®¡ç®—å¹¶æ˜¾ç¤º
  - IoU (äº¤å¹¶æ¯”)
  - Precision (ç²¾ç¡®ç‡)
  - Recall (å¬å›ç‡)
  - F1-Score
  - æ··æ·†çŸ©é˜µç»Ÿè®¡ (TP, FP, FN, TN)

- ğŸ¨ **å¤šç§å¯è§†åŒ–**: 
  - åŸå§‹æ©ç å¯¹æ¯”
  - å½©è‰²å·®å¼‚å›¾
  - çƒ­åŠ›å›¾ (ä¼ªå½©è‰²)
  - è¯¯å·®çƒ­åŠ›å›¾

## æ–‡ä»¶è¯´æ˜

### 1. `visualize_heatmap_simple.py` (æ¨èä½¿ç”¨)
ç®€åŒ–ç‰ˆå·¥å…·ï¼Œæ— éœ€åŠ è½½æ¨¡å‹ï¼Œç›´æ¥å¯¹æ¯”ä¸¤ä¸ªæ©ç å›¾åƒã€‚

**ç‰¹ç‚¹**:
- âœ… ç®€å•æ˜“ç”¨ï¼Œæ— éœ€æ¨¡å‹æƒé‡
- âœ… å¿«é€Ÿç”Ÿæˆå¯è§†åŒ–ç»“æœ
- âœ… é€‚åˆå¤§å¤šæ•°ä½¿ç”¨åœºæ™¯

### 2. `visualize_heatmap.py` (é«˜çº§ç‰ˆ)
å®Œæ•´ç‰ˆå·¥å…·ï¼Œå¯é€‰åŠ è½½æ¨¡å‹ç”Ÿæˆé¢„æµ‹ç½®ä¿¡åº¦å›¾ã€‚

**ç‰¹ç‚¹**:
- æ”¯æŒåŠ è½½åŸå§‹å›¾åƒ
- å¯è®¡ç®—é¢„æµ‹ç½®ä¿¡åº¦çƒ­åŠ›å›¾
- æ›´è¯¦ç»†çš„å¯è§†åŒ–é€‰é¡¹

## å¿«é€Ÿå¼€å§‹

### æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼

å¦‚æœæ‚¨å·²ç»è¿è¡Œäº†è®­ç»ƒè„šæœ¬å¹¶ç”Ÿæˆäº†é¢„æµ‹ç»“æœ:

```bash
# ä½¿ç”¨é»˜è®¤è·¯å¾„å¯è§†åŒ– 398.png
python visualize_heatmap_simple.py
```

è¿™å°†:
- è¯»å–é¢„æµ‹: `./save/mobile_sam_adapter/vit_change_2/pred/398.png`
- è¯»å–çœŸå®: `./data/orange/masks/398.png`
- è¾“å‡ºçƒ­åŠ›å›¾: `./defect_heatmap_398.png`

### æŒ‡å®šå…¶ä»–å›¾åƒ

```bash
# å¯è§†åŒ–å…¶ä»–å›¾åƒï¼Œä¾‹å¦‚ 123.png
python visualize_heatmap_simple.py --img_name 123
```

### å®Œå…¨è‡ªå®šä¹‰è·¯å¾„

```bash
python visualize_heatmap_simple.py \
    --pred_path ./save/mobile_sam_adapter/vit_change_2/pred/398.png \
    --gt_path ./data/orange/masks/398.png \
    --output_path ./my_custom_heatmap.png
```

### è‡ªå®šä¹‰é»˜è®¤ç›®å½•

```bash
python visualize_heatmap_simple.py \
    --img_name 398 \
    --pred_dir ./save/mobile_sam_adapter/my_experiment/pred \
    --gt_dir ./data/orange/masks
```

## é«˜çº§ç”¨æ³• (ä½¿ç”¨å®Œæ•´ç‰ˆ)

å¦‚æœæ‚¨æƒ³è¦ç”Ÿæˆé¢„æµ‹ç½®ä¿¡åº¦çƒ­åŠ›å›¾ï¼Œä½¿ç”¨ `visualize_heatmap.py`:

```bash
python visualize_heatmap.py \
    --pred_path ./save/mobile_sam_adapter/vit_change_2/pred/398.png \
    --gt_path ./data/orange/masks/398.png \
    --output_path ./defect_heatmap_with_confidence_398.png \
    --model_name mobile_sam_adapter \
    --ckpt_path ./save/mobile_sam_adapter/vit_change_2/mobile_sam_adapter_best.pth \
    --img_name 398 \
    --img_size 256
```

**å‚æ•°è¯´æ˜**:
- `--model_name`: æ¨¡å‹åç§° (ä¾‹å¦‚ `mobile_sam_adapter`)
- `--ckpt_path`: æ¨¡å‹æƒé‡æ–‡ä»¶è·¯å¾„
- `--img_size`: è¾“å…¥å›¾åƒå°ºå¯¸ (æ ¹æ®è®­ç»ƒæ—¶çš„è®¾ç½®)
- `--data_dir`: æ•°æ®é›†ç›®å½• (åŒ…å« `.npy` æ–‡ä»¶)

## æ‰¹é‡å¤„ç†å¤šå¼ å›¾åƒ

åˆ›å»ºä¸€ä¸ªç®€å•çš„æ‰¹å¤„ç†è„šæœ¬:

```bash
#!/bin/bash
# batch_visualize.sh

for img in 398 399 400 401 402; do
    echo "Processing image $img..."
    python visualize_heatmap_simple.py --img_name $img
done
```

æˆ–ä½¿ç”¨ Python:

```python
import subprocess
import os

img_names = ['398', '399', '400', '401', '402']

for img_name in img_names:
    print(f"Processing {img_name}...")
    subprocess.run([
        'python', 'visualize_heatmap_simple.py',
        '--img_name', img_name
    ])
```

## è¾“å‡ºç¤ºä¾‹

è¿è¡Œåä¼šåœ¨æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡ä¿¡æ¯:

```
============================================================
âœ… çƒ­åŠ›å›¾å·²ä¿å­˜: ./defect_heatmap_398.png
============================================================
ğŸ“Š è¯„ä¼°æŒ‡æ ‡:
   IoU (äº¤å¹¶æ¯”):     0.7845
   Precision (ç²¾ç¡®ç‡): 0.8234
   Recall (å¬å›ç‡):   0.8912
   F1-Score:         0.8560

ğŸ“ˆ æ··æ·†çŸ©é˜µç»Ÿè®¡:
   True Positive  (TP - æ­£ç¡®æ£€æµ‹):   45,678 åƒç´ 
   False Positive (FP - è¯¯æŠ¥):        9,234 åƒç´ 
   False Negative (FN - æ¼æŠ¥):        5,467 åƒç´ 
   True Negative  (TN - æ­£ç¡®èƒŒæ™¯): 205,123 åƒç´ 
============================================================
```

ç”Ÿæˆçš„çƒ­åŠ›å›¾åŒ…å« 6 ä¸ªå­å›¾:
1. **é¢„æµ‹æ©ç ** (ç°åº¦)
2. **çœŸå®æ©ç ** (ç°åº¦)
3. **å·®å¼‚åˆ†æå›¾** (å½©è‰²æ ‡æ³¨)
4. **é¢„æµ‹æ©ç çƒ­åŠ›å›¾** (ä¼ªå½©è‰²)
5. **çœŸå®æ©ç çƒ­åŠ›å›¾** (ä¼ªå½©è‰²)
6. **è¯¯å·®çƒ­åŠ›å›¾** (å·®å¼‚å¼ºåº¦)

## ä¾èµ–è¦æ±‚

### ç®€åŒ–ç‰ˆå·¥å…· (visualize_heatmap_simple.py)
```bash
pip install numpy matplotlib pillow
```

### å®Œæ•´ç‰ˆå·¥å…· (visualize_heatmap.py)
```bash
pip install numpy matplotlib pillow torch
# scipy æ˜¯å¯é€‰çš„ï¼Œç”¨äºå›¾åƒç¼©æ”¾ï¼Œå¦‚æœæ²¡æœ‰å°†ä½¿ç”¨ PIL ä½œä¸ºæ›¿ä»£
pip install scipy  # å¯é€‰
```

æ³¨æ„: å¦‚æœä½¿ç”¨å®Œæ•´ç‰ˆå·¥å…·ï¼Œè¿˜éœ€è¦é¡¹ç›®ä¸­çš„æ¨¡å‹å®šä¹‰æ–‡ä»¶ã€‚

## å¸¸è§é—®é¢˜

### Q: æç¤º "æ–‡ä»¶ä¸å­˜åœ¨" æ€ä¹ˆåŠ?

A: è¯·æ£€æŸ¥:
1. æ˜¯å¦å·²è¿è¡Œ `train.py` ç”Ÿæˆé¢„æµ‹ç»“æœ
2. è·¯å¾„æ˜¯å¦æ­£ç¡® (æ³¨æ„ç›¸å¯¹è·¯å¾„ vs ç»å¯¹è·¯å¾„)
3. æ–‡ä»¶åæ˜¯å¦æ­£ç¡® (åŒ…æ‹¬æ‰©å±•å `.png`)

### Q: çƒ­åŠ›å›¾æ˜¾ç¤ºæ•ˆæœä¸ç†æƒ³?

A: å¯ä»¥å°è¯•:
1. æ£€æŸ¥é¢„æµ‹æ©ç å’ŒçœŸå®æ©ç æ˜¯å¦éƒ½æ˜¯äºŒå€¼å›¾åƒ (0 å’Œ 255)
2. ç¡®è®¤ä¸¤ä¸ªæ©ç çš„å°ºå¯¸æ˜¯å¦åŒ¹é…
3. ä½¿ç”¨å®Œæ•´ç‰ˆå·¥å…·ç”Ÿæˆç½®ä¿¡åº¦å›¾ä»¥è·å¾—æ›´å¤šä¿¡æ¯

### Q: å¦‚ä½•åœ¨æ²¡æœ‰ GUI çš„æœåŠ¡å™¨ä¸Šè¿è¡Œ?

A: è„šæœ¬å·²ç»è®¾ç½®ä¸ºä½¿ç”¨éäº¤äº’å¼åç«¯ (`matplotlib.use('Agg')`)ï¼Œå¯ä»¥åœ¨æ—  GUI ç¯å¢ƒä¸­è¿è¡Œã€‚

### Q: ä¸­æ–‡æ ‡é¢˜æ˜¾ç¤ºä¸ºæ–¹æ¡†?

A: è¿™æ˜¯å­—ä½“é—®é¢˜ã€‚å¯ä»¥ä¿®æ”¹è„šæœ¬ä¸­çš„å­—ä½“è®¾ç½®:
```python
# åœ¨è„šæœ¬å¼€å¤´æ·»åŠ 
import matplotlib.pyplot as plt
plt.rcParams['font.sans-serif'] = ['SimHei', 'DejaVu Sans']  # ä½¿ç”¨é»‘ä½“
plt.rcParams['axes.unicode_minus'] = False  # è§£å†³è´Ÿå·æ˜¾ç¤ºé—®é¢˜
```

æˆ–è€…ç®€å•åœ°å°†æ ‡é¢˜æ”¹ä¸ºè‹±æ–‡ã€‚

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·åœ¨é¡¹ç›®ä¸­æ Issueã€‚

## è®¸å¯è¯

éµå¾ªé¡¹ç›®ä¸»ä»“åº“çš„è®¸å¯è¯ã€‚
