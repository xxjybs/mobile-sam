# 脐橙缺陷分割热力图可视化 - 使用指南

## 问题说明

您在运行 `train.py` 后发现预测结果 `/save/mobile_sam_adapter/vit_change_2/pred/398.png` 与真实掩码 `/data/orange/masks/398.png` 有较大差距。

为了帮助您分析这个问题，我创建了一套完整的热力图可视化工具。

## 工具说明

### 新增文件

1. **`visualize_heatmap_simple.py`** - 简化版可视化工具（推荐）
   - 直接对比预测掩码和真实掩码
   - 不需要加载模型
   - 快速生成可视化结果

2. **`visualize_heatmap.py`** - 完整版可视化工具
   - 可以加载模型生成预测置信度图
   - 支持显示原始图像
   - 更详细的分析

3. **`HEATMAP_VISUALIZATION_README.md`** - 详细文档（中英文）

4. **`example_heatmap_usage.py`** - 使用示例

## 快速开始

### 1. 安装依赖（如果还没安装）

```bash
pip install numpy matplotlib pillow
```

### 2. 运行简化版工具

最简单的用法（使用默认路径）：

```bash
python visualize_heatmap_simple.py
```

这将自动读取：
- 预测掩码: `./save/mobile_sam_adapter/vit_change_2/pred/398.png`
- 真实掩码: `./data/orange/masks/398.png`
- 输出热力图: `./defect_heatmap_398.png`

### 3. 查看其他图像

```bash
python visualize_heatmap_simple.py --img_name 123
```

### 4. 完全自定义路径

```bash
python visualize_heatmap_simple.py \
    --pred_path ./save/mobile_sam_adapter/vit_change_2/pred/398.png \
    --gt_path ./data/orange/masks/398.png \
    --output_path ./my_heatmap_398.png
```

## 输出说明

运行后会生成一张包含 6 个子图的热力图：

1. **预测掩码**（灰度图）
2. **真实掩码**（灰度图）
3. **差异分析图**（彩色标注）
   - 🟢 **绿色**: True Positive (TP) - 正确预测的缺陷
   - 🔴 **红色**: False Positive (FP) - 误报（错误地预测为缺陷）
   - 🟡 **黄色**: False Negative (FN) - 漏报（遗漏的缺陷）
   - ⚫ **黑色**: True Negative (TN) - 正确的背景
4. **预测掩码热力图**（伪彩色）
5. **真实掩码热力图**（伪彩色）
6. **误差热力图**（显示差异强度）

同时会在控制台输出详细的评估指标：

```
============================================================
✅ 热力图已保存: ./defect_heatmap_398.png
============================================================
📊 评估指标:
   IoU (交并比):     0.7845
   Precision (精确率): 0.8234
   Recall (召回率):   0.8912
   F1-Score:         0.8560

📈 混淆矩阵统计:
   True Positive  (TP - 正确检测):   45,678 像素
   False Positive (FP - 误报):        9,234 像素
   False Negative (FN - 漏报):        5,467 像素
   True Negative  (TN - 正确背景): 205,123 像素
============================================================
```

## 指标解释

### 1. IoU (Intersection over Union, 交并比)
- 范围: 0-1，越高越好
- 含义: 预测和真实区域的重叠程度
- 计算: IoU = (TP) / (TP + FP + FN)

### 2. Precision (精确率)
- 范围: 0-1，越高越好
- 含义: 预测为缺陷的像素中，真正是缺陷的比例
- 计算: Precision = TP / (TP + FP)
- **低精确率** → 模型有很多**误报**（把好的区域标记为缺陷）

### 3. Recall (召回率)
- 范围: 0-1，越高越好
- 含义: 所有真实缺陷中，被正确预测出来的比例
- 计算: Recall = TP / (TP + FN)
- **低召回率** → 模型有很多**漏报**（遗漏了很多缺陷）

### 4. F1-Score
- 范围: 0-1，越高越好
- 含义: 精确率和召回率的调和平均
- 计算: F1 = 2 × (Precision × Recall) / (Precision + Recall)

## 分析建议

根据可视化结果和指标，您可以：

### 如果 IoU 较低：
1. **检查差异图中的颜色分布**
   - 红色多 → 误报严重 → 模型过于敏感
   - 黄色多 → 漏报严重 → 模型不够敏感
   - 两者都多 → 边界不准确或整体性能差

### 如果精确率低（红色区域多）：
- 模型把很多正常区域误判为缺陷
- 可能需要：
  - 增加负样本训练
  - 调整阈值（如果使用阈值分割）
  - 检查是否过拟合

### 如果召回率低（黄色区域多）：
- 模型遗漏了很多真实缺陷
- 可能需要：
  - 增加正样本训练
  - 降低阈值
  - 增强数据增强

## 批量处理

如果您想批量查看多张图像的热力图：

### 方法1: Python脚本

```python
import subprocess

# 指定要可视化的图像列表
img_names = ['398', '399', '400', '401', '402']

for img_name in img_names:
    print(f"正在处理 {img_name}...")
    subprocess.run([
        'python', 'visualize_heatmap_simple.py',
        '--img_name', img_name
    ])
    
print("✅ 批量处理完成！")
```

保存为 `batch_visualize.py` 并运行：
```bash
python batch_visualize.py
```

### 方法2: Bash脚本

```bash
#!/bin/bash
for img in 398 399 400 401 402; do
    echo "正在处理图像 $img..."
    python visualize_heatmap_simple.py --img_name $img
done
echo "✅ 批量处理完成！"
```

保存为 `batch_visualize.sh`，添加执行权限并运行：
```bash
chmod +x batch_visualize.sh
./batch_visualize.sh
```

## 高级用法 - 生成置信度热力图

如果您想看到模型的预测置信度（而不仅是二值化的结果），可以使用完整版工具：

```bash
python visualize_heatmap.py \
    --pred_path ./save/mobile_sam_adapter/vit_change_2/pred/398.png \
    --gt_path ./data/orange/masks/398.png \
    --output_path ./defect_heatmap_with_confidence_398.png \
    --model_name mobile_sam_adapter \
    --ckpt_path ./save/mobile_sam_adapter/vit_change_2/mobile_sam_adapter_best.pth \
    --img_name 398 \
    --img_size 256 \
    --data_dir ./data/orange
```

这将额外生成：
- 预测置信度热力图（显示模型对每个像素的置信度，0-1之间）
- 与原始图像叠加的可视化

## 常见问题

### Q1: 运行报错 "文件不存在"

**A:** 请检查：
- 是否已经运行过 `train.py` 并生成了预测结果
- 路径是否正确（注意相对路径 vs 绝对路径）
- 文件名是否匹配（包括扩展名 `.png`）

### Q2: 提示缺少依赖模块

**A:** 运行以下命令安装：
```bash
pip install numpy matplotlib pillow
```

如果使用高级版工具还需要：
```bash
pip install torch scipy
```

### Q3: 中文显示为方框

**A:** 这是字体问题，可以：
1. 忽略（不影响功能）
2. 或者编辑脚本，在开头添加：
```python
import matplotlib.pyplot as plt
plt.rcParams['font.sans-serif'] = ['SimHei', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False
```

### Q4: 想要修改颜色方案

**A:** 编辑脚本中的这部分：
```python
diff_map[tp] = [0, 255, 0]    # 绿色 - 可以改为其他RGB值
diff_map[fp] = [255, 0, 0]    # 红色
diff_map[fn] = [255, 255, 0]  # 黄色
```

### Q5: 如何保存为高分辨率图像

**A:** 编辑脚本，修改 `plt.savefig` 这行：
```python
plt.savefig(output_path, dpi=300, bbox_inches='tight')  # 改为300 dpi
```

## 更多帮助

- 查看命令行帮助: `python visualize_heatmap_simple.py --help`
- 阅读详细文档: `HEATMAP_VISUALIZATION_README.md`
- 查看示例: `python example_heatmap_usage.py`

## 总结

通过这些工具，您可以：
1. ✅ 直观地看到预测与真实的差异
2. ✅ 定量分析模型性能（IoU, Precision, Recall等）
3. ✅ 识别模型的弱点（误报多还是漏报多）
4. ✅ 为改进模型提供依据

希望这些工具能帮助您分析和改进模型！如有问题，请随时提出。
